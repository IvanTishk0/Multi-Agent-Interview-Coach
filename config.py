"""
Конфигурация системы интервью.

Содержит настройки LLM, темы вопросов по грейдам
и системные промпты для агентов.
"""
import os
from typing import Dict, List, Optional

GROQ_API_KEY = os.getenv("GROQ_API_KEY", "")
GROQ_BASE_URL = "https://api.groq.com/openai/v1"

LLM_MODEL = "llama-3.1-8b-instant"
LLM_TEMPERATURE = 0.7

MAX_TURNS = 10
TEAM_NAME = "Multi-Agent Interview Coach"

TOPICS_BY_GRADE: Dict[str, List[str]] = {
    "Junior": [
        "Базовые типы данных в Python",
        "Списки и словари",
        "Циклы и условные операторы",
        "Функции и аргументы",
        "Основы ООП",
        "Работа с файлами",
        "Обработка исключений",
        "Основы SQL",
        "Git основы",
        "HTTP методы"
    ],
    "Middle": [
        "Декораторы и генераторы",
        "Контекстные менеджеры",
        "Многопоточность и асинхронность",
        "Паттерны проектирования",
        "ORM и базы данных",
        "REST API дизайн",
        "Тестирование",
        "Docker основы",
        "Оптимизация запросов SQL",
        "Кэширование"
    ],
    "Senior": [
        "Архитектура микросервисов",
        "Распределенные системы",
        "Масштабирование",
        "CI/CD пайплайны",
        "Kubernetes",
        "Мониторинг и логирование",
        "Безопасность приложений",
        "Оптимизация производительности",
        "Системный дизайн",
        "Лидерство и менторство"
    ]
}

ROLE_LABELS: Dict[str, str] = {
    "backend": "Backend Developer",
    "frontend": "Frontend Developer",
    "devops": "DevOps / SRE",
    "qa": "QA Engineer",
    "data_engineer": "Data Engineer",
    "data_science": "Data Scientist",
    "ml_engineer": "ML Engineer",
    "mobile": "Mobile Developer"
}

ROLE_KEYWORDS: Dict[str, List[str]] = {
    "backend": ["backend", "back-end", "server", "api", "django", "fastapi", "flask"],
    "frontend": ["frontend", "front-end", "react", "vue", "angular", "ui", "javascript", "typescript"],
    "devops": ["devops", "sre", "infra", "infrastructure", "kubernetes", "k8s", "ci/cd", "cicd"],
    "qa": ["qa", "тест", "tester", "test", "quality"],
    "data_engineer": ["data engineer", "data engineering", "etl", "dwh", "warehouse", "airflow", "spark"],
    "data_science": ["data scientist", "data science", "аналит", "analysis", "статист", "statistics"],
    "ml_engineer": ["ml engineer", "machine learning", "mlops", "model serving", "inference"],
    "mobile": ["mobile", "android", "ios", "swift", "kotlin", "react native", "flutter"]
}


def detect_role_from_position(position: str, default: str = "backend") -> str:
    pos = (position or "").lower()
    for role, keywords in ROLE_KEYWORDS.items():
        for kw in keywords:
            if kw in pos:
                return role
    return default


TOPICS_BY_ROLE_AND_DIFFICULTY: Dict[str, Dict[int, List[str]]] = {
    "backend": {
        1: ["что такое переменная", "базовые типы данных", "условия if/else"],
        2: ["списки и словари", "функции", "обработка исключений"],
        3: ["ООП основы", "HTTP методы и коды", "основы SQL (SELECT, JOIN)"],
        4: ["REST API и сериализация", "транзакции и изоляция", "индексы и планы запросов"],
        5: ["аутентификация и авторизация", "кэширование", "тестирование backend"],
        6: ["асинхронность и конкурентность", "очереди и фоновые задачи", "наблюдаемость (логи/метрики)"],
        7: ["проектирование API", "идемпотентность", "безопасность веб-приложений"],
        8: ["архитектура сервисов", "границы контекстов", "контрактное тестирование"],
        9: ["микросервисы и коммуникации", "consistency модели", "SLA/SLO"],
        10: ["системный дизайн", "масштабирование", "устойчивость и отказоустойчивость"]
    },
    "frontend": {
        1: ["основы HTML", "основы CSS", "что такое DOM"],
        2: ["базовый JavaScript", "события и обработчики", "fetch и HTTP"],
        3: ["компонентный подход", "state и props", "TypeScript основы"],
        4: ["React/Vue жизненный цикл", "роутинг", "формы и валидация"],
        5: ["управление состоянием", "оптимизация рендеринга", "тестирование UI"],
        6: ["сборка (Vite/Webpack)", "код-сплиттинг", "CSS архитектура"],
        7: ["SSR/CSR", "кэширование на клиенте", "доступность (a11y)"],
        8: ["архитектура фронтенда", "design system", "наблюдаемость фронта"],
        9: ["безопасность (XSS/CSRF)", "перформанс", "микрофронтенды"],
        10: ["системный дизайн UI", "масштабирование команды/кода", "DX и стандарты"]
    },
    "devops": {
        1: ["Linux основы", "сеть: DNS/HTTP", "Git основы"],
        2: ["процессы и права", "bash основы", "мониторинг basics"],
        3: ["Docker основы", "логирование", "CI основы"],
        4: ["Kubernetes основы", "секреты и конфиги", "Ingress/Service"],
        5: ["IaC (Terraform)", "CD практики", "управление инцидентами"],
        6: ["observability (метрики/трейсы)", "SLO/SLA", "управление релизами"],
        7: ["безопасность инфраструктуры", "policy-as-code", "backup/DR"],
        8: ["платформенная инженерия", "мульти-кластер", "надёжность"]
        ,
        9: ["архитектура облака", "cost optimization", "resilience patterns"],
        10: ["системный дизайн платформы", "хаос-инжиниринг", "эволюция архитектуры"]
    },
    "qa": {
        1: ["что такое баг", "тест-кейсы", "классы эквивалентности"],
        2: ["тест-дизайн", "чек-листы", "репортинг дефектов"],
        3: ["API тестирование", "SQL основы", "HTTP коды"],
        4: ["автоматизация тестов основы", "pytest/playwright/selenium", "моки и стабы"],
        5: ["интеграция с CI", "флейки тесты", "контрактное тестирование"],
        6: ["нагрузочное тестирование", "безопасность basics", "логирование и диагностика"],
        7: ["стратегия тестирования", "метрики качества", "risk-based testing"],
        8: ["построение QA процесса", "quality gates", "стандарты"]
        ,
        9: ["тестирование распределённых систем", "наблюдаемость", "устойчивость"]
        ,
        10: ["качество на уровне организации", "управление рисками", "leadership"]
    },
    "data_engineer": {
        1: ["SQL основы", "типовые агрегаты", "моделирование данных basics"],
        2: ["ETL/ELT понятия", "качество данных", "форматы CSV/JSON"],
        3: ["партиционирование", "индексы", "оконные функции"],
        4: ["оркестрация (Airflow)", "DWH concepts", "SCD"],
        5: ["Spark основы", "оптимизация джобов", "data contracts"],
        6: ["стриминг (Kafka)", "exactly-once/at-least-once", "schema registry"],
        7: ["lakehouse", "каталог данных", "governance"],
        8: ["надёжность пайплайнов", "observability", "cost optimization"],
        9: ["архитектура платформы данных", "multi-tenant", "безопасность"],
        10: ["системный дизайн данных", "эволюция схем", "масштабирование"]
    },
    "data_science": {
        1: ["numpy/pandas основы", "описательная статистика", "предобработка данных"],
        2: ["линейная регрессия", "классификация basics", "метрики качества"],
        3: ["валидация и переобучение", "feature engineering", "train/test split"],
        4: ["кросс-валидация", "подбор гиперпараметров", "баланс классов"],
        5: ["интерпретируемость", "A/B тесты", "утечки данных"],
        6: ["пайплайны обучения", "ML в проде basics", "мониторинг качества модели"],
        7: ["временные ряды", "NLP basics", "рекомендательные системы basics"],
        8: ["эксперименты", "causal thinking", "надёжность данных"]
        ,
        9: ["масштабирование обучения", "feature store", "MLOps"],
        10: ["дизайн ML-систем", "trade-offs", "governance"]
    },
    "ml_engineer": {
        1: ["основы ML", "метрики и валидация", "Python для ML"],
        2: ["pipeline инференса", "feature engineering", "регуляризация"],
        3: ["контейнеризация модели", "REST/gRPC для сервинга", "batch vs online"],
        4: ["мониторинг дрейфа", "версионирование моделей", "эксперименты"],
        5: ["оптимизация инференса", "квантизация", "latency/throughput"],
        6: ["оркестрация (Airflow/Kubeflow)", "feature store", "model registry"],
        7: ["надёжность ML сервиса", "алерты", "rollback стратеги"],
        8: ["архитектура ML платформы", "безопасность данных", "privacy"],
        9: ["распределённое обучение", "ускорение (GPU)", "оптимизация стоимости"],
        10: ["системный дизайн ML", "компромиссы", "governance"]
    },
    "mobile": {
        1: ["основы платформы (Android/iOS)", "UI компоненты", "жизненный цикл"],
        2: ["навигация", "состояние экрана", "сетевые запросы"],
        3: ["архитектурные паттерны", "хранение данных", "параллельность"],
        4: ["работа с API", "кэширование", "обработка ошибок"],
        5: ["тестирование", "инструменты профилирования", "безопасность basics"],
        6: ["оптимизация производительности", "offline-first", "доступность"],
        7: ["модульность", "CI/CD для мобильных", "релизы"]
        ,
        8: ["архитектура приложения", "наблюдаемость", "обновления"]
        ,
        9: ["сложные интеграции", "декомпозиция", "масштабирование"],
        10: ["системный дизайн", "стандарты", "leadership"]
    }
}


TOPICS_BY_ROLE_AND_GRADE: Dict[str, Dict[str, List[str]]] = {
    "backend": {
        "Junior": [
            "HTTP и REST основы",
            "Основы SQL",
            "Базовый Python",
            "Git",
            "Ошибки и исключения"
        ],
        "Middle": [
            "Проектирование REST API",
            "Транзакции, изоляции, индексы",
            "Асинхронность",
            "Docker",
            "Тестирование и качество"
        ],
        "Senior": [
            "Микросервисы",
            "Системный дизайн",
            "Наблюдаемость",
            "Безопасность",
            "Масштабирование"
        ]
    },
    "frontend": {
        "Junior": [
            "HTML/CSS",
            "JavaScript основы",
            "DOM и события",
            "HTTP/Fetch",
            "Git"
        ],
        "Middle": [
            "React/Vue/Angular",
            "TypeScript",
            "Управление состоянием",
            "Тестирование UI",
            "Перформанс"
        ],
        "Senior": [
            "Архитектура фронтенда",
            "SSR/SSG",
            "Безопасность (XSS/CSRF)",
            "Микрофронтенды",
            "DX и стандарты"
        ]
    },
    "devops": {
        "Junior": [
            "Linux",
            "Сети",
            "Docker основы",
            "CI basics",
            "Логирование"
        ],
        "Middle": [
            "Kubernetes",
            "Terraform/IaC",
            "Observability",
            "Release/Deployment",
            "Secrets/PKI"
        ],
        "Senior": [
            "SRE и SLO",
            "Архитектура платформы",
            "Надёжность и DR",
            "Cost optimization",
            "Incident response"
        ]
    },
    "qa": {
        "Junior": [
            "Тест-кейсы и баг-репорты",
            "Тест-дизайн",
            "HTTP",
            "API testing basics",
            "SQL основы"
        ],
        "Middle": [
            "Автоматизация тестов",
            "Интеграция с CI",
            "Контрактное тестирование",
            "Нагрузочное тестирование",
            "Тестирование безопасности basics"
        ],
        "Senior": [
            "Стратегия качества",
            "Метрики и процессы",
            "Тестирование распределённых систем",
            "Quality gates",
            "Лидерство"
        ]
    },
    "data_engineer": {
        "Junior": [
            "SQL",
            "ETL/ELT",
            "Моделирование данных",
            "Качество данных",
            "Форматы данных"
        ],
        "Middle": [
            "Airflow",
            "Spark",
            "DWH",
            "Streaming (Kafka)",
            "Data contracts"
        ],
        "Senior": [
            "Архитектура платформы данных",
            "Governance",
            "Observability",
            "Безопасность",
            "Cost/Performance"
        ]
    },
    "data_science": {
        "Junior": [
            "Pandas/Numpy",
            "Статистика basics",
            "Предобработка",
            "Базовые модели",
            "Метрики"
        ],
        "Middle": [
            "Feature engineering",
            "CV/Hyperparam tuning",
            "A/B тесты",
            "SQL для аналитики",
            "Интерпретируемость"
        ],
        "Senior": [
            "ML в проде",
            "MLOps",
            "Системный дизайн ML",
            "Эксперименты",
            "Governance"
        ]
    },
    "ml_engineer": {
        "Junior": [
            "ML основы",
            "Валидация и метрики",
            "Model serving basics",
            "Docker",
            "Python"
        ],
        "Middle": [
            "Pipeline инференса",
            "Мониторинг дрейфа",
            "Оптимизация инференса",
            "Feature store",
            "Orchestration"
        ],
        "Senior": [
            "Distributed training",
            "Архитектура ML платформы",
            "Надёжность",
            "Стоимость",
            "Governance"
        ]
    },
    "mobile": {
        "Junior": [
            "UI основы",
            "Lifecycle",
            "Networking",
            "Хранение данных",
            "Git"
        ],
        "Middle": [
            "Архитектура приложения",
            "Параллельность",
            "Тестирование",
            "Performance",
            "Release"
        ],
        "Senior": [
            "Модульность",
            "CI/CD",
            "Наблюдаемость",
            "Безопасность",
            "Системный дизайн"
        ]
    }
}

INTERVIEWER_SYSTEM_PROMPT = """Ты опытный технический интервьюер в IT-компании. Твоя задача — провести техническое собеседование с кандидатом.

ВАЖНЫЕ ПРАВИЛА:
1. Задавай вопросы по одному, не перегружай кандидата
2. Внимательно слушай ответы и задавай уточняющие вопросы при необходимости
3. Адаптируй сложность вопросов под уровень кандидата
4. Будь вежлив и профессионален
5. Если кандидат затрудняется — дай подсказку или упрости вопрос
6. Если кандидат задает встречный вопрос — ОБЯЗАТЕЛЬНО ответь на него, прежде чем продолжить интервью
7. НЕ соглашайся с явно неверными утверждениями кандидата
8. Возвращай беседу к теме интервью, если кандидат уходит от темы
9. НЕ задавай вопросы, ответы на которые кандидат уже дал ранее

Информация о кандидате:
- Имя: {candidate_name}
- Позиция: {position}
- Грейд: {grade}
- Опыт: {experience}

Текущий ход интервью: {turn_number}
"""

MENTOR_SYSTEM_PROMPT = """Ты опытный ментор (Observer) на техническом интервью. Твоя задача — анализировать ответы кандидата и давать рекомендации интервьюеру.

ТВОИ ОБЯЗАННОСТИ:
1. Анализировать каждый ответ кандидата на корректность
2. Выявлять ошибки, неточности и пробелы в знаниях
3. Оценивать уровень уверенности кандидата
4. Проверять факты — если кандидат утверждает что-то необычное, это может быть галлюцинация
5. Давать рекомендации интервьюеру по следующим вопросам
6. Отслеживать, какие темы уже были затронуты
7. Рекомендовать изменение сложности вопросов
ВАЖНЫЕ ПРАВИЛА ДЛЯ difficulty_recommendation:
- НИКОГДА не рекомендуй "increase", если correctness_score < 80.
- Если кандидат признал незнание ("не знаю"), ВСЕГДА рекомендуй "decrease".
- Если ответ частично верный, используй "maintain".
ФОРМАТ ОТВЕТА:
Всегда отвечай в формате JSON:
{{
    "analysis": "Краткий анализ ответа кандидата",
    "is_correct": true/false/null,
    "correctness_score": 0-100,
    "confidence_level": "high/medium/low",
    "red_flags": ["список выявленных проблем"],
    "is_hallucination": true/false,
    "is_question_from_candidate": true/false,
    "is_off_topic": true/false,
    "topic_detected": "тема ответа",
    "difficulty_recommendation": "increase/decrease/maintain",
    "recommendation": "Рекомендация для интервьюера",
    "suggested_action": "ask_followup/simplify/move_on/challenge/answer_question/redirect_to_topic"
}}
ПРИМЕРЫ ОБРАБОТКИ ГАЛЛЮЦИНАЦИЙ (FEW-SHOT):

Пример 1 (Несуществующая версия):
Кандидат: "Я жду выхода Python 4.0, потому что там обещали убрать GIL."
Анализ: {
    "analysis": "Кандидат упоминает несуществующую версию Python 4.0 и связывает её с удалением GIL.",
    "is_correct": false,
    "correctness_score": 0,
    "red_flags": ["Галлюцинация: Python 4.0 не существует", "Ложный факт об удалении GIL в Python 4.0"],
    "is_hallucination": true,
    "recommendation": "Вежливо поправьте кандидата: Python 4.0 не планируется, а работа над удалением GIL ведется в рамках PEP 703 для Python 3.13+."
}

Пример 2 (Выдуманный функционал):
Кандидат: "В Django 6.0 добавили встроенную поддержку нейросетей для ORM."
Анализ: {
    "analysis": "Кандидат утверждает о наличии функционала в несуществующей версии Django 6.0.",
    "is_correct": false,
    "correctness_score": 0,
    "red_flags": ["Галлюцинация: Django 6.0 еще не существует", "Выдуманный функционал ORM"],
    "is_hallucination": true,
    "recommendation": "Укажите, что текущая версия Django — 5.x, и таких планов для ORM официально нет."
}

Пример 3 (Ложное техническое утверждение):
Кандидат: "GIL в Python был полностью удален еще в версии 3.8, теперь потоки работают параллельно."
Анализ: {
    "analysis": "Кандидат уверенно сообщает ложный технический факт о GIL.",
    "is_correct": false,
    "correctness_score": 10,
    "red_flags": ["Критическая ошибка: непонимание работы GIL", "Ложное утверждение о версии 3.8"],
    "is_hallucination": true,
    "recommendation": "Спросите, как тогда работают CPU-bound задачи в Python, чтобы проверить глубину заблуждения."
}

ВАЖНО: 
- Если кандидат упоминает несуществующие версии Python (например, Python 4.0), фреймворков или технологий — это критическая ошибка (галлюцинация). Отметь is_hallucination: true.
- Если кандидат задает вопрос интервьюеру — отметь is_question_from_candidate: true.
- Если кандидат уходит от темы интервью — отметь is_off_topic: true.
"""

FACT_CHECKER_PROMPT = """Ты эксперт по проверке фактов в области программирования и IT.

Проверь следующее утверждение кандидата:
"{statement}"

Определи:
1. Является ли это утверждение правдой или ложью
2. Если ложь — объясни, в чем ошибка
3. Приведи правильную информацию

Ответь в формате JSON:
{{
    "is_true": true/false,
    "explanation": "Подробное объяснение",
    "correct_info": "Правильная информация (если утверждение ложно)"
}}
"""

FEEDBACK_GENERATOR_PROMPT = """Ты эксперт по оценке кандидатов на технических собеседованиях.

На основе истории интервью сгенерируй подробный структурированный отчет.

История интервью:
{interview_history}

Информация о кандидате:
- Имя: {candidate_name}
- Позиция: {position}
- Грейд: {grade}
- Опыт: {experience}

ВАЖНО ДЛЯ knowledge_gaps:
- Для КАЖДОГО вопроса, на который кандидат ответил неправильно или не ответил, ОБЯЗАТЕЛЬНО укажи:
  - topic: тема вопроса
  - question: сам вопрос
  - correct_answer: ПОДРОБНЫЙ правильный ответ (это критически важно!)

ВАЖНО ДЛЯ resources:
- Укажи КОНКРЕТНЫЕ ссылки на документацию и ресурсы для изучения
- Например: "https://docs.python.org/3/tutorial/", "https://realpython.com/", "https://habr.com/ru/articles/"

Сгенерируй отчет в следующем формате JSON:
{{
    "verdict": {{
        "grade": "Junior/Middle/Senior (фактический уровень на основе ответов)",
        "hiring_recommendation": "Hire/No Hire/Strong Hire",
        "confidence_score": 0-100
    }},
    "technical_review": {{
        "confirmed_skills": ["список подтвержденных навыков с пояснениями"],
        "knowledge_gaps": [
            {{
                "topic": "тема",
                "question": "вопрос, на который кандидат не ответил",
                "correct_answer": "ПОДРОБНЫЙ правильный ответ"
            }}
        ]
    }},
    "soft_skills": {{
        "clarity": "оценка ясности изложения (1-10)",
        "honesty": "оценка честности (1-10)",
        "engagement": "оценка вовлеченности (1-10)",
        "comments": "комментарии по soft skills"
    }},
    "roadmap": {{
        "topics_to_improve": ["список тем для изучения"],
        "resources": [
            "https://docs.python.org/3/tutorial/ - Официальный туториал Python",
            "https://realpython.com/ - Практические руководства",
            "другие конкретные ресурсы"
        ]
    }},
    "summary": "Общее резюме по кандидату"
}}
"""
